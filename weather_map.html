<!DOCTYPE html>
<html lang="en">
<head>
    <!--  Meta for standard and responsive design  -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Weather Map Project</title>
    <!--  links for bootstrap CSS  -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!--  links for mapbox  -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css' rel='stylesheet'/>
    <link rel="stylesheet"
          href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css"
          type="text/css">

</head>
<body>
<div class="container">
<header class="row text-center ">
    <h1 class=" col-12  text-center header-bar" id="header-title">Weather APP</h1>
<!--  updates as location updates  -->
    <ul class="col-12">
        <li class=" list-unstyled header-bar" id="header-current">Current City:</li>
        <li class="list-unstyled header-bar" id="header-city-name">city</li>
    </ul>
<!--  values for proper card generation  -->
    <div class="col-12 d-flex flex-col justify-content-between align-items-between">
        <div><input  class="forecast-select" type="radio" id="seven-day" name="Forecast" value="7">
            <label for="seven-day">7 Day Forecast</label><br></div>
        <div><input class="forecast-select" type="radio" id="five-day" name="Forecast" value="5" checked="true"><label for="five-day">5 Day Forecast</label></div>
        <div> <input class="forecast-select" type="radio" id="three-day" name="Forecast" value="3">
            <label for="three-day">3 Day Forecast</label></div>
       </div>
    <div class="col-12 d-flex justify-content-center"><div id="geocoder" class="geocoder"></div></div>

</header>
<main>
<!--  map & weather cards  -->
    <div class="row my-2">
        <div class="col-12 col-lg-6"><div id="weatherDIV" class="row d-flex flex-row flex-wrap flex-md-wrap justify-content-center align-items-center"></div></div>
        <div class="col"><div id='map' style='width: 100%; height: 500px;'></div></div>

    </div>



</main>
</div>


<!--  script for JQuery, Popper.js, Bootstrap JS  -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

<!--  script for keys, mapboxAPI -->
<script src="./js/keys.js"></script>
<script src='https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js'></script>
<script src="./lecture/js/mapbox-geocoder-utils.js"></script>

<!-- Load the `mapbox-gl-geocoder` plugin. -->
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css"
      type="text/css">

<!--  custom script for openWeatherAPI   -->
<script>
    "use strict"

    // function to convert time to a proper date
    function dateConverter(num) {
        var number = new Date(num * 1000).toString();
        var properDate = [(number.slice(4, 15)), (number.slice(0,3))]
        return properDate
    }

    // functions for fail and always methods for api requests
    function onAlways() {console.log('loading')}
    function onFail() {console.log('error'), alert('Bad Request')}

    var popUpContent = ''

    //function for current data to display in popup friendly format
    function renderCurrent(object) {
        var content = `<div id="weather-card-current" class="card w-100 p-2 text-center">`
        content += `<div class="card-body p-0">`
        content += `<h5 class="card-title p-0">${object.temp.toFixed(0)}째F</h5>`
        content += `<p class="card-text p-0"><img id="weather-icon" src="http://openweathermap.org/img/w/${object.weather[0].icon}.png
" /></p></div>`
        content += `<ul class="list-group list-group-flush p-0">`
        content += `<li class="list-group-item p-0"><strong>${object.humidity.toFixed(0)}%</strong></li>`
        content += `<li class="list-group-item p-0"><strong>${object.wind_speed.toFixed(0)}mph</strong></li>`
        content += `<li class="list-group-item p-1">Feels like <strong>${object.feels_like.toFixed(0)}째F</strong></li></ul></div>`
        popUpContent = content
    }

    // function to get information from OpenWeather API for one day
    function renderCard(object, index) {
        var content = `<div id="weather-card-${index}" class="card p-0 col-4 col-md-3 col-lg-4 col-xl-4 w-100 mx-auto my-2">`
        content += `<div class="d-md-none d-flex justify-content-center p-1 w-100 card-header">${dateConverter(object.dt)[1]}</div>`
        content += `<div class="d-none d-md-flex p-1 w-100 card-header justify-content-center">${dateConverter(object.dt)[0]}</div>`
        content += `<div class="card-body p-1">`
        content += `<h6 class="card-title d-flex justify-content-center">${object.temp.max.toFixed(0)}째F/${object.temp.min.toFixed(0)}째F</h6>`
        content += `<p class="card-text d-flex justify-content-center"><img id="weather-icon" src="http://openweathermap.org/img/w/${object.weather[0].icon}.png
" /></p></div>`
        content += `<p class="card-text d-none d-md-flex justify-content-center"><strong>${object.weather[0].description}</strong></p>`
        content += `<ul class="list-group list-group-flush p-1">`
        content += `<li class="list-group-item d-flex justify-content-center p-1"><strong>${object.humidity}</strong>%</li>`
        content += `<li class="list-group-item d-flex justify-content-center p-1"><strong>${object.wind_speed.toFixed(0)}</strong>mph</li>`
        content += `<li class="list-group-item d-none d-md-flex justify-content-center p-1"><strong>${object.pressure}</strong>hPa</li>`
        content += `</ul></div>`
        $('#weatherDIV').append(content)
    }

    //mapbox token = mapbox access
    mapboxgl.accessToken = mapboxToken;
    var defaultLocation = 'San Antonio, TX'
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-v9',
        center: [0, 0],
        Zoom: 10
    })
    //mapbox marker generation
    var initialMarker = new mapboxgl.Marker({
        color: 'cornflowerblue',
        draggable: true
    }).setLngLat({lng: 0, lat: 0}).addTo(map)
    //mapbox geocoder generation
    var geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        marker: false
    });
    document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

    // event to load and display proper data upon input into geocoder
    geocoder.on('result', function (result) {
        $('#header-city-name').text($('.mapboxgl-ctrl-geocoder--input').val())
        initialMarker.setLngLat({lng: result.result.center[0], lat: result.result.center[1]}).addTo(map)
        $.get("https://api.openweathermap.org/data/2.5/onecall", {
            appId: OPEN_WEATHER_APPID,
            lat: result.result.center[1],
            lon: result.result.center[0],
            units: "imperial",
        }).always(onAlways).fail(onFail).done(function (data) {
            renderCurrent(data.current)
            initialMarker.setPopup(new mapboxgl.Popup({closeButton: false, closeOnMove: true}).setHTML(popUpContent))
            $('#weatherDIV').html(' ')
            data.daily.forEach(function (element, index) {
                if (index < $(':checked').val() ) {
                    renderCard(element, index)
                }
            })
        })
    })

    // function for error callback if geolocation disabled by user
    function error() {
        $('#search').val(defaultLocation);
        $('#header-city-name').text(`${defaultLocation}`);
        alert('default position enabled');
        geocode(defaultLocation, mapboxToken).then(function (results) {
            map.flyTo({center: results, zoom: 13})
            initialMarker.setLngLat(results)
            $.get("https://api.openweathermap.org/data/2.5/onecall", {
                appId: OPEN_WEATHER_APPID,
                lat: initialMarker.getLngLat().lat,
                lon: initialMarker.getLngLat().lng,
                units: "imperial",
            }).always(onAlways).fail(onFail).done(function (data) {
                renderCurrent(data.current)
                initialMarker.setPopup(new mapboxgl.Popup({closeButton: false, closeOnMove: true}).setHTML(popUpContent))
                $('#weatherDIV').html(' ')
                data.daily.forEach(function (element, index) {
                    if (index < $(':checked').val()) {
                        renderCard(element, index)
                    }
                })
            })
        })
    }

    // function for successful geolocation of user, load/display correct information
    function success(position) {
        reverseGeocode({
            lat: position.coords.latitude,
            lng: position.coords.longitude
        }, mapboxToken).then(function (results) {
            $('#header-city-name').text(results);
            map.flyTo({center: [position.coords.longitude, position.coords.latitude], zoom: 13})
            initialMarker.setLngLat({lng: position.coords.longitude, lat: position.coords.latitude})
            $.get("https://api.openweathermap.org/data/2.5/onecall", {
                appId: OPEN_WEATHER_APPID,
                lat: initialMarker.getLngLat().lat,
                lon: initialMarker.getLngLat().lng,
                units: "imperial",
            }).always(onAlways).fail(onFail).done(function (data) {
                renderCurrent(data.current)
                initialMarker.setPopup(new mapboxgl.Popup({closeButton: false, closeOnMove: true}).setHTML(popUpContent));
                $('#weatherDIV').html(' ')
                data.daily.forEach(function (element, index) {
                    if (index < $(':checked').val()) {
                        renderCard(element, index)
                    }
                })
            })
        })
    }

    // if/else for geolocation capability of user equiptment
    if (!navigator.geolocation) {
        console.log('geolocation not supported by browser');
        $('#header-city-name').text(defaultLocation);
        error()
        alert('geolocation not supported');
    }
    else {
        console.log('locating...');
        navigator.geolocation.getCurrentPosition(success, error)
        console.log('done');
    }

    // function for updating infromation followed by generation of the new information
    function onDragEnd() {
        var lngLat = initialMarker.getLngLat();
        console.log('hey')
        reverseGeocode({lng: lngLat.lng, lat: lngLat.lat}, mapboxToken).then(function (results) {
            $('#header-city-name').text(results);
            $.get("https://api.openweathermap.org/data/2.5/onecall", {
                appId: OPEN_WEATHER_APPID,
                lat: lngLat.lat,
                lon: lngLat.lng,
                units: "imperial",
            }).always(onAlways).fail(onFail).done(function (data) {
                renderCurrent(data.current)
                initialMarker.setPopup(new mapboxgl.Popup({closeButton: false, closeOnMove: true}).setHTML(popUpContent))
                $('#weatherDIV').html(' ')
                data.daily.forEach(function (element, index) {
                    if (index < $(':checked').val()) {
                        renderCard(element, index)
                    }
                })
            })
        })
    }

    // function for updating card rendering based on radio input
    function forecastDisplay(){
        var lngLat = initialMarker.getLngLat();
        $.get("https://api.openweathermap.org/data/2.5/onecall", {
            appId: OPEN_WEATHER_APPID,
            lat: lngLat.lat,
            lon: lngLat.lng,
            units: "imperial",
        }).always(onAlways).fail(onFail).done(function (data) {
            renderCurrent(data.current)
            initialMarker.setPopup(new mapboxgl.Popup({closeButton: false, closeOnMove: true}).setHTML(popUpContent))
            $('#weatherDIV').html(' ')
            data.daily.forEach(function (element, index) {
                if (index < $(':checked').val()) {
                    renderCard(element, index)
                }
            })
        })
    };

$(window).on('load',function(){
    if ($(window).innerWidth() < 576){
        $('#three-day').attr('checked', true)
        forecastDisplay()
    }
    else if ($(window).innerWidth() > 922){
        $('#seven-day').attr('checked', true)
        forecastDisplay()
    }
})
    $(window).on('resize',function(){
        if ($(window).innerWidth() < 576){
            $('#three-day').attr('checked', true)
            forecastDisplay()
        }
        else if ($(window).innerWidth() > 922){
            $('#seven-day').attr('checked', true)
            forecastDisplay()
        }
        else {
            $('#five-day').attr('checked', true)
            forecastDisplay()
        }
    })

    // event for proper display based on radio button selection, updates as changed
    $('.forecast-select').on('change', forecastDisplay)
    initialMarker.on('dragend', onDragEnd);
    //     $(document).ready(function () {
</script>
</body>
</html>